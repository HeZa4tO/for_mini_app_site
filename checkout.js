document.addEventListener("DOMContentLoaded", () => {
    const cart = JSON.parse(sessionStorage.getItem("cart") || "[]");
    const checkoutCart = document.getElementById("checkoutCart");
    const totalSumDiv = document.getElementById("totalSum");
    const sendButton = document.getElementById("sendOrder");
    const formContainer = document.querySelector(".checkout-form");

    const RUB_RATE = 13;
    
    // –¶–µ–Ω—ã –¥–æ—Å—Ç–∞–≤–∫–∏ –î–û–õ–ñ–ù–´ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º–∏, —á—Ç–æ –≤ script.js
    const DELIVERY_PRICES = {
        "üëü –ö—Ä–æ—Å—Å–æ–≤–∫–∏": {"–û–±—ã—á–Ω–∞—è üöö": 2000, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 6500},
        "ü•æ –ë–æ—Ç–∏–Ω–∫–∏": {"–û–±—ã—á–Ω–∞—è üöö": 2100, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 7000},
        "üß• –¢–æ–ª—Å—Ç–æ–≤–∫–∏, –∫–æ—Ñ—Ç—ã, –ª—ë–≥–∫–∏–µ –∫—É—Ä—Ç–∫–∏": {"–û–±—ã—á–Ω–∞—è üöö": 1500, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 5000},
        "üëï –§—É—Ç–±–æ–ª–∫–∏, —à–æ—Ä—Ç—ã": {"–û–±—ã—á–Ω–∞—è üöö": 1300, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 4500},
        "üëñ –®—Ç–∞–Ω—ã, –¥–∂–∏–Ω—Å—ã": {"–û–±—ã—á–Ω–∞—è üöö": 1500, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 5000},
        "üß§ –ó–∏–º–Ω–∏–µ –∫—É—Ä—Ç–∫–∏, –ø–∞–ª—å—Ç–æ": {"–û–±—ã—á–Ω–∞—è üöö": 1700, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 5500},
        "üß¶ –ù–æ—Å–∫–∏, –º–∞–π–∫–∏, –Ω–∏–∂–Ω–µ–µ –±–µ–ª—å—ë": {"–û–±—ã—á–Ω–∞—è üöö": 700, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 4000},
        "üï∂ –û—á–∫–∏, –ø–∞—Ä—Ñ—é–º, —É–∫—Ä–∞—à–µ–Ω–∏—è, —á–∞—Å—ã": {"–û–±—ã—á–Ω–∞—è üöö": 700, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 4000},
        "üß¢ –ì–æ–ª–æ–≤–Ω—ã–µ —É–±–æ—Ä—ã": {"–û–±—ã—á–Ω–∞—è üöö": 700, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 4000},
        "üëú –°—É–º–∫–∏ (–º–∞–ª–µ–Ω—å–∫–∏–µ)": {"–û–±—ã—á–Ω–∞—è üöö": 1400, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 5000},
        "üéí –°—É–º–∫–∏ (–±–æ–ª—å—à–∏–µ)": {"–û–±—ã—á–Ω–∞—è üöö": 1700, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 6500},
        "üì¶ –î—Ä—É–≥–æ–µ": {"–û–±—ã—á–Ω–∞—è üöö": 1500, "–≠–∫—Å–ø—Ä–µ—Å—Å üöÄ": 5000}
    };

    let totalRub = 0;
    checkoutCart.innerHTML = "";

    cart.forEach((item, index) => {
        const priceYuan = Number(item.price || 1);
        const priceRub = Math.ceil(priceYuan * RUB_RATE);
        const deliveryPrice = DELIVERY_PRICES[item.category]?.[item.delivery] || 2000;
        const deliveryRub = Math.ceil(deliveryPrice);
        const taxRub = Math.ceil(priceRub * 0.1);
        const itemTotalRub = Math.ceil(priceRub + deliveryRub + taxRub);
        totalRub += itemTotalRub;

        const div = document.createElement("div");
        div.className = "checkout-item";
        div.innerHTML = `
            <div class="checkout-item-header">
                <strong>${item.category}</strong>
            </div>
            <div class="checkout-item-details">
                <div>–°—Å—ã–ª–∫–∞: ${item.link || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                <div>–¶–µ–Ω–∞: ¬•${priceYuan} (‚ÇΩ${priceRub})</div>
                <div>–†–∞–∑–º–µ—Ä: ${item.size || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                <div>–¶–≤–µ—Ç: ${item.color}</div>
                <div>–î–æ—Å—Ç–∞–≤–∫–∞: ${item.delivery} (‚ÇΩ${deliveryRub})</div>
                <div class="item-total">–ò—Ç–æ–≥–æ: ‚ÇΩ${itemTotalRub}</div>
            </div>
        `;
        checkoutCart.appendChild(div);
    });

    totalSumDiv.textContent = `üí∞ –û–±—â–∞—è —Å—É–º–º–∞: ‚ÇΩ${Math.ceil(totalRub).toLocaleString()}`;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–µ–¥—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    if (!window.Telegram?.WebApp) {
        showBrowserInstruction();
    }

    sendButton.addEventListener("click", async () => {
        const fullname = document.getElementById("fullname")?.value.trim() || "";
        const phone = document.getElementById("phone")?.value.trim() || "";
        const city = document.getElementById("city")?.value.trim() || "";
        const address = document.getElementById("address")?.value.trim() || "";

        if (!fullname || !phone || !city || !address) {
            showError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã!");
            return;
        }

        if (cart.length === 0) {
            showError("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞! –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞.");
            return;
        }

        const orderData = {
            items: cart,
            total: totalRub,
            user: { 
                fullname, 
                phone, 
                city, 
                address 
            },
            timestamp: new Date().toISOString()
        };

        console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:", orderData);

        try {
            sendButton.disabled = true;
            sendButton.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

            // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Telegram WebApp
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.sendData(JSON.stringify(orderData));
                showSuccess("‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ Telegram!");
                
                setTimeout(() => {
                    Telegram.WebApp.close();
                }, 2000);
            } else {
                // –†–ï–ñ–ò–ú –ë–†–ê–£–ó–ï–†–ê - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                showBrowserInstruction(orderData);
                sendButton.disabled = false;
                sendButton.textContent = "üì¶ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑";
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
            showError("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
            
            sendButton.disabled = false;
            sendButton.textContent = "üì¶ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑";
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    function showBrowserInstruction(orderData = null) {
        const orderText = orderData ? formatOrderForManual(orderData) : "–í–∞—à –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –∑–¥–µ—Å—å...";
        
        const instructionHTML = `
            <div class="browser-instruction" style="
                background: #1e1e1e;
                border: 2px solid #ffeaa7;
                border-radius: 10px;
                padding: 20px;
                margin: 20px 0;
                text-align: center;
            ">
                <h3 style="color: #ffffffff; margin-bottom: 15px;">‚ùå –û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –≤ Telegram!</h3>
                
                <p style="margin-bottom: 15px; color: #ffffffff;">
                    –î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç WebApp –≤ Telegram:
                </p>
                
                <div style="background: #1e1e1e; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram</strong><br>
                    <strong>2. –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞:</strong> @av_drops_bot<br>
                    <strong>3. –ù–∞–∂–º–∏—Ç–µ "üõí –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω"</strong><br>
                    <strong>4. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏ –æ—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑</strong>
                </div>

                <div style="background: #1e1e1e; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
                    <strong>–í–∞—à –∑–∞–∫–∞–∑:</strong>
                    <div style="margin-top: 10px; font-family: monospace; font-size: 12px; background: #1e1e1e; padding: 10px; border-radius: 5px;">
                        ${orderText}
                    </div>
                </div>

                <p style="color: #ffffffff; font-size: 14px;">
                    üí° <strong>–°–æ–≤–µ—Ç:</strong> –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É –≤—Ä—É—á–Ω—É—é
                </p>
            </div>
        `;

        // –ó–∞–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º—É –Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        if (formContainer) {
            formContainer.style.display = 'none';
        }
        
        checkoutCart.innerHTML = instructionHTML;
        sendButton.style.display = 'none';
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –¥–ª—è —Ä—É—á–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
    function formatOrderForManual(orderData) {
        const user = orderData.user;
        const items = orderData.items;
        
        let message = `–ù–û–í–´–ô –ó–ê–ö–ê–ó\\n\\n`;
        message += `–ö–ª–∏–µ–Ω—Ç: ${user.fullname}\\n`;
        message += `–¢–µ–ª–µ—Ñ–æ–Ω: ${user.phone}\\n`;
        message += `–ê–¥—Ä–µ—Å: ${user.city}, ${user.address}\\n\\n`;
        
        message += `–¢–û–í–ê–†–´:\\n`;
        items.forEach((item, index) => {
            message += `${index + 1}. ${item.category}\\n`;
            message += `   –¶–µ–Ω–∞: ¬•${item.price}\\n`;
            message += `   –†–∞–∑–º–µ—Ä: ${item.size}\\n`;
            message += `   –¶–≤–µ—Ç: ${item.color}\\n`;
            message += `   –î–æ—Å—Ç–∞–≤–∫–∞: ${item.delivery}\\n`;
            message += `   –°—Å—ã–ª–∫–∞: ${item.link}\\n\\n`;
        });
        
        message += `–û–ë–©–ê–Ø –°–£–ú–ú–ê: ‚ÇΩ${orderData.total.toLocaleString()}\\n`;
        message += `–í–†–ï–ú–Ø: ${new Date().toLocaleString()}`;
        
        return message;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–æ–∫
    function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4757;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-weight: 500;
            max-width: 90%;
            text-align: center;
            animation: slideDown 0.3s ease;
        `;
        errorDiv.textContent = message;
        
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    function showSuccess(message) {
        const successDiv = document.createElement("div");
        successDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2ed573;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-weight: 500;
            max-width: 90%;
            text-align: center;
            animation: slideDown 0.3s ease;
        `;
        successDiv.textContent = message;
        
        document.body.appendChild(successDiv);
        
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 5000);
    }

    // CSS –∞–Ω–∏–º–∞—Ü–∏—è
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .browser-instruction {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);
});